{% extends 'base.html' %}

{% block title %}Service Cost Estimator | Sellux Plaster Ltd{% endblock %}

{% block content %}
<div class="container my-5 fade-in-up">
    <div class="row justify-content-center">
        <div class="col-lg-7">
            <div class="card shadow-md p-lg-5 p-4">
                <div class="card-body">
                    <div class="text-center mb-5">
                        <h1 class="display-5 fw-bold">Cost Estimator</h1>
                        <p class="lead text-muted">Calculate an estimate for your next interior project.</p>
                    </div>
                    <div id="error-container" class="alert alert-danger" style="display: none;"></div>
                    <form id="estimation-form" method="post">
                        {% csrf_token %}
                        <div class="mb-4">
                            <label for="id_service" class="form-label fs-5">Service</label>
                            {{ form.service }}
                        </div>
                        <div class="mb-4">
                            <label for="id_area" class="form-label fs-5">Area (m²)</label>
                            {{ form.area }}
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Calculate Estimate</button>
                        </div>
                    </form>
                    <div id="result-container" class="text-center mt-5" style="display: none;">
                        <div class="p-4 bg-light rounded-3">
                            <p class="text-muted mb-2">Estimated Cost</p>
                            <h2 id="estimated-cost" class="display-4 fw-bold text-primary"></h2>
                            <hr class="my-4">
                            <p class="small text-muted mb-0">This is an approximate cost. For a detailed quote including materials and transportation, please contact our team.</p>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'contact:contact_us' %}" class="btn btn-primary">Request a Formal Quote</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    document.getElementById('estimation-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const url = form.action;
        const errorContainer = document.getElementById('error-container');
        const resultContainer = document.getElementById('result-container');

        errorContainer.style.display = 'none';
        errorContainer.innerHTML = '';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.estimated_cost) {
                document.getElementById('estimated-cost').textContent = `GH₵${data.estimated_cost}`;
                resultContainer.style.display = 'block';
            }
        })
        .catch(error => {
            if (error.errors) {
                for (const field in error.errors) {
                    const errorList = error.errors[field];
                    errorList.forEach(err => {
                        const errorNode = document.createElement('p');
                        errorNode.textContent = err.message || err;
                        errorContainer.appendChild(errorNode);
                    });
                }
                errorContainer.style.display = 'block';
            } else {
                console.error('Error:', error);
            }
        });
    });
</script>
{% endblock extra_js %}
