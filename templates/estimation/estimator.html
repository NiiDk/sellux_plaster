{% extends 'base.html' %}
{% load static %}

{% block title %}Service Cost Estimator | Sellux Plaster Ltd{% endblock %}

{% block content %}
<section class="bg-pattern-3d position-relative border-bottom pt-5 pb-5">
    <div class="position-absolute bottom-0 start-0 w-100 h-75" style="background: linear-gradient(to top, #ffffff 0%, transparent 100%);"></div>
    <div class="container position-relative z-1 pt-4 text-center">
        <div class="animate__animated animate__fadeInDown">
            <span class="d-inline-block border border-dark px-3 py-1 rounded-pill small fw-bold text-uppercase ls-2 mb-3 bg-white">
                Project Planning
            </span>
            <h1 class="display-3 fw-bold text-dark mb-3">Cost Estimator</h1>
            <p class="lead text-muted fs-5 opacity-75 col-lg-6 mx-auto">
                Calculate a preliminary investment figure for your interior project based on surface area and finish type.
            </p>
        </div>
    </div>
</section>

<section class="py-5 bg-white">
    <div class="container py-lg-5">
        <div class="row g-0 shadow-lg rounded-5 overflow-hidden border border-light-subtle animate__animated animate__fadeInUp">

            <div class="col-lg-5 bg-black text-white p-5 position-relative">
                <div class="position-absolute top-0 start-0 w-100 h-100 bg-pattern-dots opacity-25"></div>

                <div class="position-relative z-1">
                    <h3 class="h4 fw-bold font-heading mb-4 text-primary">Specifications</h3>

                    <form id="estimation-form" method="post" class="estimator-form">
                        {% csrf_token %}
                        <div id="error-container" class="alert alert-danger small py-2" style="display: none; background: rgba(220, 53, 69, 0.2); border-color: #dc3545; color: #ff8e98;"></div>

                        <div class="mb-4">
                            <label for="id_service" class="form-label small fw-bold text-uppercase ls-1 opacity-75">Material/Service Type</label>
                            <div class="select-wrapper">
                                {{ form.service }}
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="id_area" class="form-label small fw-bold text-uppercase ls-1 opacity-75">Total Surface Area (m²)</label>
                            <div class="input-group-custom">
                                {{ form.area }}
                                <span class="unit-label">m²</span>
                            </div>
                            <small class="text-white-50 mt-2 d-block fst-italic">Enter the total wall or ceiling measurement.</small>
                        </div>

                        <div class="d-grid mt-5">
                            <button type="submit" class="btn btn-primary btn-lg rounded-pill fw-bold py-3 shadow-float transition-all">
                                Calculate Investment <i class="bi bi-arrow-right-circle ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="col-lg-7 bg-white p-5 d-flex align-items-center justify-content-center border-start border-light position-relative">

                <div id="result-placeholder" class="text-center opacity-25">
                    <i class="bi bi-calculator display-1 mb-3 d-block"></i>
                    <p class="fs-5 fw-medium">Input project specs to view valuation</p>
                </div>

                <div id="result-container" class="text-center w-100 animate__animated animate__fadeIn" style="display: none;">
                    <span class="text-uppercase text-muted fw-bold ls-2 small mb-2 d-block">Estimated Total</span>
                    <h2 id="estimated-cost" class="display-1 fw-bold text-dark mb-4"></h2>

                    <div class="col-lg-9 mx-auto">
                        <div class="p-3 bg-light rounded-4 mb-4 border border-light-subtle">
                            <p class="text-muted small mb-0 lh-lg">
                                <strong>Disclaimer:</strong> This figure represents a baseline professional estimate.
                                Final costs may vary based on site complexity, decorative additions, and transportation.
                            </p>
                        </div>

                        <div class="d-flex flex-column flex-sm-row justify-content-center gap-3 mt-5">
                            <a href="{% url 'contact:contact_us' %}" class="btn btn-dark rounded-pill px-5 py-3 fw-bold shadow-sm">
                                Request Precise Quote
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    /* Typography & Core Styles */
    .ls-1 { letter-spacing: 1px; }
    .ls-2 { letter-spacing: 2px; }
    .font-heading { font-family: 'Montserrat', sans-serif; }

    /* --- INPUT VISIBILITY FIX --- */
    .estimator-form select,
    .estimator-form input {
        width: 100%;
        background: rgba(255, 255, 255, 0.08) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: #ffffff !important; /* Forces text visibility while typing */
        padding: 15px 20px;
        border-radius: 12px;
        outline: none;
        transition: all 0.3s ease;
        font-size: 1.15rem;
        font-weight: 600;
    }

    /* Style for the Input wrapper to hold the unit */
    .input-group-custom { position: relative; }
    .unit-label {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.4);
        font-weight: bold;
        pointer-events: none;
    }

    /* Input Focus States */
    .estimator-form select:focus,
    .estimator-form input:focus {
        background: rgba(255, 255, 255, 0.15) !important;
        border-color: var(--primary-color) !important;
        box-shadow: 0 0 0 4px rgba(217, 106, 0, 0.2) !important;
    }

    /* Select Dropdown Fix */
    .estimator-form select option { background: #000; color: #fff; }

    /* Button Styling */
    .shadow-float { box-shadow: 0 4px 15px rgba(217, 106, 0, 0.3); }
    .shadow-float:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(217, 106, 0, 0.5); }
</style>

{% endblock content %}

{% block extra_js %}
<script>
    const form = document.getElementById('estimation-form');
    const areaInput = document.querySelector('input[name="area"]');
    const serviceSelect = document.querySelector('select[name="service"]');

    // Function to handle the AJAX call
    function performCalculation() {
        const formData = new FormData(form);
        const url = form.action;
        const errorContainer = document.getElementById('error-container');
        const resultContainer = document.getElementById('result-container');
        const resultPlaceholder = document.getElementById('result-placeholder');

        // Don't calculate if input is empty to avoid unnecessary errors
        if(!areaInput.value) return;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
        .then(response => {
            if (!response.ok) return response.json().then(err => Promise.reject(err));
            return response.json();
        })
        .then(data => {
            if (data.estimated_cost) {
                document.getElementById('estimated-cost').textContent = `GH₵${data.estimated_cost}`;
                resultPlaceholder.style.display = 'none';
                resultContainer.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Calculation Error:', error);
        });
    }

    // Trigger calculation as user types (Input Event)
    areaInput.addEventListener('input', performCalculation);

    // Trigger calculation when service changes
    serviceSelect.addEventListener('change', performCalculation);

    // Also handle standard submit for accessibility
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        performCalculation();
    });
</script>
{% endblock extra_js %}